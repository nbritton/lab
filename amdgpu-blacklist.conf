# /etc/modprobe.d/amdgpu-blacklist.conf
#
# Prevent amdgpu from autoloading during early boot on MacPro7,1.
#
# The resize-gpu-bars.service needs to resize the PCIe BARs from 256 MB
# to 32 GB BEFORE amdgpu binds to the GPUs. If amdgpu autoloads first,
# the driver initializes with 256 MB BARs, then the resize service must
# unbind → resize → remove → rescan → rebind, causing a double init/teardown
# cycle that corrupts KFD state (/dev/kfd returns EINVAL).
#
# With this blacklist, the boot sequence is:
#   1. Kernel enumerates PCI devices (no driver binds to GPUs)
#   2. resize-gpu-bars.service writes rebar registers + PCI rescan
#   3. resize-gpu-bars.service runs: modprobe amdgpu
#   4. amdgpu loads ONCE with 32 GB BARs — KFD initializes cleanly
#
# This blacklist only prevents udev-triggered autoloading.
# Explicit "modprobe amdgpu" still works (used by the resize service).
#
# To undo: delete this file and run "systemctl disable resize-gpu-bars.service"

blacklist amdgpu
